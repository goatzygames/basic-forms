<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Basic Forms — Create</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main class="container">
    <header class="topbar">
      <h1>Basic Forms</h1>
      <p class="muted">Create surveys & shareable forms (Firebase + Chart.js)</p>
    </header>

    <section class="card">
      <input type="text" id="form-name" class="form-title" placeholder="Untitled Form">
      <textarea id="form-description" class="form-desc" placeholder="Form description"></textarea>

      <div id="questions-container"></div>

      <button id="add-question-btn" class="floating-btn">+</button>

      <div class="row right">
        <button id="create-form-btn" class="btn primary">Create Form</button>
      </div>

      <div id="share-area" class="share hidden">
        <h3>Form created!</h3>
        <input id="share-link" readonly>
        <div class="row">
          <a id="open-link" class="btn" target="_blank">Open form</a>
          <a id="open-edit" class="btn">Open editor</a>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
  import { createFormDoc, uidShort } from './main.js';

  const container = document.getElementById('questions-container');
  const addBtn = document.getElementById('add-question-btn');
  const createBtn = document.getElementById('create-form-btn');
  const shareArea = document.getElementById('share-area');
  const shareLinkInput = document.getElementById('share-link');
  const openLink = document.getElementById('open-link');
  const openEdit = document.getElementById('open-edit');

  let questions = [];

  function renderQuestions() {
    container.innerHTML = '';
    questions.forEach((q, idx) => {
      const card = document.createElement('div');
      card.className = 'question-card';
      card.innerHTML = `
        <div class="q-header">
          <strong>${idx + 1}. ${q.label || '(no label)'}</strong>
          <div>
            <button class="btn small edit">Edit</button>
            <button class="btn small danger delete">Delete</button>
          </div>
        </div>
        <div class="q-meta">
          <em>${q.type}</em>
          ${q.options ? `<div class="options">${q.options.join(', ')}</div>` : ''}
          ${q.scaleMin ? `<div class="options">Scale: ${q.scaleMin} — ${q.scaleMax}</div>` : ''}
        </div>
      `;
      card.querySelector('.delete').onclick = () => { questions.splice(idx,1); renderQuestions(); };
      card.querySelector('.edit').onclick = () => editQuestion(idx);
      container.appendChild(card);
    });
  }

  function editQuestion(index) {
    const q = questions[index];
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-card">
        <h3>Edit Question</h3>
        <label>Label<input id="q-label" value="${q.label || ''}"></label>
        <label>Required <input type="checkbox" id="q-required" ${q.required?'checked':''}></label>
        <div id="q-options-area"></div>
        <div class="row right">
          <button id="q-save" class="btn primary">Save</button>
          <button id="q-cancel" class="btn">Cancel</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    const optionsArea = modal.querySelector('#q-options-area');
    if (q.type === 'multiple' || q.type === 'checkboxes' || q.type === 'dropdown') {
      optionsArea.innerHTML = `<textarea id="q-options-text" rows="5">${q.options.join('\n')}</textarea>`;
    } else if (q.type === 'linear') {
      optionsArea.innerHTML = `<input type="number" id="q-min" value="${q.scaleMin}"> - <input type="number" id="q-max" value="${q.scaleMax}">`;
    }

    modal.querySelector('#q-cancel').onclick = () => modal.remove();
    modal.querySelector('#q-save').onclick = () => {
      q.label = modal.querySelector('#q-label').value.trim() || '(no label)';
      q.required = modal.querySelector('#q-required').checked;
      if (q.type === 'multiple' || q.type === 'checkboxes' || q.type === 'dropdown') {
        q.options = modal.querySelector('#q-options-text').value.split('\n').map(s=>s.trim()).filter(Boolean);
      } else if (q.type === 'linear') {
        q.scaleMin = Number(modal.querySelector('#q-min').value)||1;
        q.scaleMax = Number(modal.querySelector('#q-max').value)||(q.scaleMin+1);
      }
      questions[index]=q;
      modal.remove();
      renderQuestions();
    };
  }

  addBtn.onclick = () => {
    const q = { id: uidShort(), type: 'short', label:'Untitled question', required:false, options:[], scaleMin:1, scaleMax:5 };
    questions.push(q);
    renderQuestions();
  };

  createBtn.onclick = async () => {
    const name = document.getElementById('form-name').value.trim()||'Untitled Form';
    const formId = `${name.toLowerCase().replace(/\W+/g,'-')}-${uidShort()}`;
    const formObj = { id: formId, name, createdAt: new Date().toISOString(), questions, answers: [] };
    await createFormDoc(formId, formObj);
    shareArea.classList.remove('hidden');
    shareLinkInput.value = `${location.origin}/form.html?id=${formId}`;
    openLink.href = shareLinkInput.value;
    openEdit.href = `edit-form.html?id=${formId}`;
  };

  renderQuestions();
  </script>
</body>
</html>
