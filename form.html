<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Basic Form — Answer</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <main class="container">
    <header class="topbar">
      <h1 id="form-title">Loading…</h1>
      <p id="form-meta" class="muted"></p>
    </header>

    <section class="card hidden" id="form-card">
      <form id="answer-form"></form>
      <div class="row right">
        <button id="submit-btn" class="btn primary">Submit</button>
      </div>
    </section>

    <div class="card hidden" id="notfound">
      <h2>Form not found</h2>
    </div>
  </main>

  <script type="module">
    import { fetchFormDoc, submitFormAnswer } from './main.js';

    const params = new URLSearchParams(location.search);
    const formId = params.get('id');
    const titleEl = document.getElementById('form-title');
    const metaEl = document.getElementById('form-meta');
    const formCard = document.getElementById('form-card');
    const notFound = document.getElementById('notfound');
    const answerForm = document.getElementById('answer-form');

    if (!formId) { notFound.classList.remove('hidden'); titleEl.textContent='Invalid link'; }

    let currentForm = null;

    async function loadForm() {
      const doc = await fetchFormDoc(formId);
      if (!doc) { notFound.classList.remove('hidden'); return; }
      currentForm = doc;
      titleEl.textContent = doc.name;
      metaEl.textContent = `Created by ${doc.creatorName||'Anonymous'}`;
      renderQuestions(doc.questions||[]);
      formCard.classList.remove('hidden');
    }

    function renderQuestions(questions) {
      answerForm.innerHTML='';
      questions.forEach(q=>{
        const div = document.createElement('div');
        div.className='field';
        const label = document.createElement('label');
        label.innerHTML=`<span>${q.label} ${q.required?'<em class="muted">*</em>':''}</span>`;
        div.appendChild(label);

        let inputEl;
        if(q.type==='short'){ inputEl=document.createElement('input'); inputEl.type='text'; inputEl.name=q.id; inputEl.placeholder=q.label; }
        else if(q.type==='paragraph'){ inputEl=document.createElement('textarea'); inputEl.name=q.id; inputEl.rows=4; }
        else if(q.type==='multiple'||q.type==='checkboxes'){
          inputEl=document.createElement('div');
          q.options.forEach((opt,idx)=>{
            const id=`${q.id}_${idx}`;
            inputEl.innerHTML+=`<div class="option"><input type="${q.type==='multiple'?'radio':'checkbox'}" name="${q.id}" id="${id}" value="${opt}"><label for="${id}">${opt}</label></div>`;
          });
        } else if(q.type==='dropdown'){
          inputEl=document.createElement('select'); inputEl.name=q.id;
          const placeholder=document.createElement('option'); placeholder.value=''; placeholder.textContent='Select…'; inputEl.appendChild(placeholder);
          q.options.forEach(opt=>{ const o=document.createElement('option'); o.value=opt; o.textContent=opt; inputEl.appendChild(o); });
        } else if(q.type==='linear'){
          inputEl=document.createElement('div');
          inputEl.innerHTML=`<input type="range" name="${q.id}" min="${q.scaleMin}" max="${q.scaleMax}" value="${Math.round((q.scaleMin+q.scaleMax)/2)}"><output></output>`;
          const range=inputEl.querySelector('input'); const out=inputEl.querySelector('output'); out.value=range.value;
          range.addEventListener('input',()=>{ out.value=range.value; });
        }

        div.appendChild(inputEl);
        answerForm.appendChild(div);
      });
    }

    document.getElementById('submit-btn').onclick=async e=>{
      e.preventDefault();
      const answers={};
      currentForm.questions.forEach(q=>{
        if(q.type==='short'||q.type==='paragraph'){ answers[q.id]=answerForm.querySelector(`[name="${q.id}"]`).value.trim(); }
        else if(q.type==='multiple'){ const el=answerForm.querySelector(`[name="${q.id}"]:checked`); answers[q.id]=el?el.value:''; }
        else if(q.type==='checkboxes'){ const els=Array.from(answerForm.querySelectorAll(`[name="${q.id}"]:checked`)).map(i=>i.value); answers[q.id]=els; }
        else if(q.type==='dropdown'){ answers[q.id]=answerForm.querySelector(`[name="${q.id}"]`).value; }
        else if(q.type==='linear'){ answers[q.id]=answerForm.querySelector(`[name="${q.id}"]`).value; }
      });
      await submitFormAnswer(formId, { submittedAt:new Date().toISOString(), values:answers });
      alert('Submitted!'); answerForm.reset();
    };

    loadForm();
  </script>
</body>
</html>
