<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Basic Form — Form</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <main class="container">
<header class="topbar">
<a href="index.html">
  <h1>Basic Forms</h1>
</a>
  <p class="muted">Create surveys & shareable forms</p>
  <nav class="navbar">
    <ul>
      <li><a href="index.html">Create Form</a></li>
      <li style="display:none;"><a href="#about">About</a></li>
      <li style="display:none;"><a href="#contact">Contact</a></li>
    </ul>
  </nav>
</header>
	<br><br><br><br><br>

    <section id="form-card" class="card hidden">
	      <h1 id="form-title">Loading…</h1>
      <p id="form-meta" class="muted"></p>
      <form id="answer-form"></form>
	  
	  <a id="edit-link" href="#" class="btn">Edit this Form</a>

      <div class="row right">
        <button id="submit-answer" class="btn primary">Submit</button>
        <button id="toggle-results" class="btn">See Results</button>
      </div>

<div id="result-area" class="hidden">
  <h3>Results</h3>
  <div id="results-content"></div>
  <div class="export-buttons">
    <button id="export-csv" class="btn">Export CSV</button>
    <button id="export-excel" class="btn">Export Excel</button>
  </div>
</div>

    </section>

    <div id="notfound" class="card hidden" style="display:none;">
      <h2>Form not found</h2>
      <p>Check the link or ask the creator for the correct shareable link.</p>
    </div>

    <footer class="foot muted">
      <small>Answers are stored in Firebase.</small>
    </footer>
  </main>

  <script type="module" src="main.js"></script>
  <script type="module">
    import {
      fetchFormDoc,
      submitFormAnswer,
      listenFormRealtime
    } from './main.js';

    const params = new URLSearchParams(location.search);
    const formId = params.get('id');
    const titleEl = document.getElementById('form-title');
    const metaEl = document.getElementById('form-meta');
    const card = document.getElementById('form-card');
    const notfound = document.getElementById('notfound');
    const answerForm = document.getElementById('answer-form');
    const submitBtn = document.getElementById('submit-answer');
    const resultsArea = document.getElementById('result-area');
    const resultsContent = document.getElementById('results-content');
    const toggleResults = document.getElementById('toggle-results');

if (!formId) {
  titleEl.textContent = 'Invalid form link';
  notfound.classList.remove('hidden');
} else {
  loadForm(formId);
}

document.getElementById('edit-link').href = `edit-form.html?id=${formId}`;

    let currentForm = null;
    let charts = {}; // map question.id -> Chart instance

    async function loadForm(id) {
      try {
        const doc = await fetchFormDoc(id);
        if (!doc) {
          notfound.classList.remove('hidden');
          return;
        }
        currentForm = doc;
        titleEl.textContent = doc.name;
        metaEl.textContent = `Created by ${doc.creatorName || 'Anonymous'}`;
        renderQuestionsUI(doc.questions || []);
        card.classList.remove('hidden');

        listenFormRealtime(id, (updatedDoc) => {
          currentForm = updatedDoc;
          if (!resultsArea.classList.contains('hidden')) {
            renderResults();
          }
        });
      } catch (err) {
        console.error(err);
        alert('Error loading form. See console.');
      }
    }

    function renderQuestionsUI(questions = []) {
      answerForm.innerHTML = '';
      questions.forEach(q => {
        const wrapper = document.createElement('div');
        wrapper.className = 'field';
        const label = document.createElement('label');
        label.innerHTML = `<span>${escapeHtml(q.label)} ${q.required ? '<em class="muted">*</em>' : ''}</span>`;
        wrapper.appendChild(label);

        let inputEl;
        if (q.type === 'short') {
          inputEl = document.createElement('input');
          inputEl.type = 'text';
          inputEl.name = q.id;
          inputEl.placeholder = q.label;
        } else if (q.type === 'paragraph') {
          inputEl = document.createElement('textarea');
          inputEl.name = q.id;
          inputEl.rows = 4;
        } else if (q.type === 'multiple') {
          inputEl = document.createElement('div');
          q.options.forEach((opt, idx) => {
            const id = `${q.id}_opt_${idx}`;
            inputEl.innerHTML += `<div class="option"><input type="radio" name="${q.id}" id="${id}" value="${escapeAttr(opt)}"><label for="${id}">${escapeHtml(opt)}</label></div>`;
          });
        } else if (q.type === 'checkboxes') {
          inputEl = document.createElement('div');
          q.options.forEach((opt, idx) => {
            const id = `${q.id}_cb_${idx}`;
            inputEl.innerHTML += `<div class="option"><input type="checkbox" name="${q.id}" id="${id}" value="${escapeAttr(opt)}"><label for="${id}">${escapeHtml(opt)}</label></div>`;
          });
        } else if (q.type === 'dropdown') {
          inputEl = document.createElement('select');
          inputEl.name = q.id;
          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = 'Select…';
          inputEl.appendChild(placeholder);
          q.options.forEach(opt => {
            const o = document.createElement('option');
            o.value = opt;
            o.textContent = opt;
            inputEl.appendChild(o);
          });
        } else if (q.type === 'linear') {
          inputEl = document.createElement('div');
          inputEl.innerHTML = `<div class="row"><input type="range" name="${q.id}" min="${q.scaleMin}" max="${q.scaleMax}" value="${Math.round((q.scaleMin+q.scaleMax)/2)}" id="${q.id}_range"><output for="${q.id}_range" id="${q.id}_out"></output></div>`;
        } else {
          inputEl = document.createElement('input'); inputEl.name = q.id;
        }

        wrapper.appendChild(inputEl);
        if (q.type === 'linear') {
          const out = wrapper.querySelector(`#${q.id}_out`);
          const range = wrapper.querySelector(`#${q.id}_range`);
          out.value = range.value;
          range.addEventListener('input', () => { out.value = range.value; });
        }

        answerForm.appendChild(wrapper);
      });
    }

    submitBtn.onclick = async (e) => {
      e.preventDefault();
      if (!currentForm) return;
      const answers = {};
      let valid = true;
      (currentForm.questions || []).forEach(q => {
        if (q.type === 'short' || q.type === 'paragraph') {
          const el = answerForm.querySelector(`[name="${q.id}"]`);
          answers[q.id] = el ? el.value.trim() : '';
        } else if (q.type === 'multiple') {
          const el = answerForm.querySelector(`[name="${q.id}"]:checked`);
          answers[q.id] = el ? el.value : '';
        } else if (q.type === 'checkboxes') {
          const els = Array.from(answerForm.querySelectorAll(`[name="${q.id}"]:checked`)).map(i => i.value);
          answers[q.id] = els;
        } else if (q.type === 'dropdown') {
          const el = answerForm.querySelector(`[name="${q.id}"]`);
          answers[q.id] = el ? el.value : '';
        } else if (q.type === 'linear') {
          const el = answerForm.querySelector(`[name="${q.id}_range"]`);
          answers[q.id] = el ? el.value : '';
        }
        if (q.required) {
          const v = answers[q.id];
          if ((Array.isArray(v) && v.length === 0) || (!Array.isArray(v) && (v === '' || v === null || v === undefined))) {
            alert(`Please answer required question: ${q.label}`);
            valid = false;
          }
        }
      });
      if (!valid) return;

      const answerObj = {
        submittedAt: new Date().toISOString(),
        values: answers
      };
      try {
        await submitFormAnswer(currentForm.id, answerObj);
        alert('Thanks — your response was submitted.');
        answerForm.reset();
        (currentForm.questions || []).forEach(q => {
          if (q.type === 'linear') {
            const out = answerForm.querySelector(`#${q.id}_out`);
            const range = answerForm.querySelector(`#${q.id}_range`);
            if (range && out) out.value = range.value;
          }
        });
      } catch (err) {
        console.error(err);
        alert('Error submitting answer.');
      }
    };

    toggleResults.onclick = (e) => {
      e.preventDefault();
      if (!resultsArea.classList.contains('hidden')) {
        resultsArea.classList.add('hidden');
        toggleResults.textContent = 'See Results';
      } else {
        resultsArea.classList.remove('hidden');
        toggleResults.textContent = 'See Results';
        renderResults();
      }
    };

function renderResults() {
  resultsContent.innerHTML = '';
  const questions = (currentForm.questions || []);
  const answers = (currentForm.answers || []);
  if (!answers.length) {
    resultsContent.innerHTML = '<p class="muted">No responses yet.</p>';
    return;
  }

  questions.forEach(q => {
    const qCard = document.createElement('div');
    qCard.className = 'result-question';
    qCard.innerHTML = `<h4>${escapeHtml(q.label)}</h4>`;

    if (q.type === 'short' || q.type === 'paragraph') {
      const table = document.createElement('table');
      table.className = 'answers-table';
      table.innerHTML = `<thead><tr><th>Answer</th><th>Date</th></tr></thead><tbody></tbody>`;
      const tbody = table.querySelector('tbody');

      answers.forEach(a => {
        const v = a.values[q.id];
        if (v && v.toString().trim()) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(v)}</td><td>${new Date(a.submittedAt).toLocaleString()}</td>`;
          tbody.appendChild(tr);
        }
      });

      if (!tbody.children.length) {
        qCard.innerHTML += '<p class="muted">No responses yet.</p>';
      } else {
        qCard.appendChild(table);
      }
      resultsContent.appendChild(qCard);

    } else if (q.type === 'multiple' || q.type === 'dropdown' || q.type === 'checkboxes') {
      const counts = {};
      const options = (q.options || []).slice();
      options.forEach(opt => counts[opt] = 0);

      answers.forEach(a => {
        const v = a.values[q.id];
        if (Array.isArray(v)) {
          v.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
        } else if (v) {
          counts[v] = (counts[v] || 0) + 1;
        }
      });

      const canvas = document.createElement('canvas');
      canvas.id = 'chart-' + q.id;
      qCard.appendChild(canvas);
      resultsContent.appendChild(qCard);

      const labels = Object.keys(counts);
      const data = Object.values(counts);
      if (charts[q.id]) charts[q.id].destroy();
      charts[q.id] = new Chart(canvas.getContext('2d'), {
        type: 'doughnut',
        data: { labels, datasets: [{ data }] },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } }
        }
      });

    } else if (q.type === 'linear') {
      const vals = answers.map(a => Number(a.values[q.id])).filter(v => !isNaN(v));
      if (!vals.length) {
        qCard.innerHTML += '<p class="muted">No responses yet.</p>';
      } else {
        const sum = vals.reduce((s, n) => s + n, 0);
        const avg = (sum / vals.length).toFixed(2);
        const min = Math.min(...vals);
        const max = Math.max(...vals);
        qCard.innerHTML += `<p>Responses: ${vals.length} — avg: ${avg}, min: ${min}, max: ${max}</p>`;

        const canvas = document.createElement('canvas');
        qCard.appendChild(canvas);
        resultsContent.appendChild(qCard);

        if (charts[q.id]) charts[q.id].destroy();
        charts[q.id] = new Chart(canvas.getContext('2d'), {
          type: 'bar',
          data: {
            labels: vals.map((_, i) => `#${i+1}`),
            datasets: [{ data: vals }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });
      }
    }
  });
}

// --- Export helpers ---
function exportCSV() {
  if (!currentForm || !currentForm.answers?.length) return;

  let csv = "Submitted At," + currentForm.questions.map(q => `"${q.label}"`).join(",") + "\n";
  currentForm.answers.forEach(a => {
    let row = `"${new Date(a.submittedAt).toLocaleString()}"`;
    currentForm.questions.forEach(q => {
      let val = a.values[q.id];
      if (Array.isArray(val)) val = val.join("; ");
      row += `,"${val || ""}"`;
    });
    csv += row + "\n";
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.setAttribute("href", url);
  link.setAttribute("download", `${currentForm.name || "form_results"}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function exportExcel() {
  if (!currentForm || !currentForm.answers?.length) return;

  let xls = "<table><tr><th>Submitted At</th>";
  currentForm.questions.forEach(q => xls += `<th>${escapeHtml(q.label)}</th>`);
  xls += "</tr>";

  currentForm.answers.forEach(a => {
    xls += "<tr>";
    xls += `<td>${new Date(a.submittedAt).toLocaleString()}</td>`;
    currentForm.questions.forEach(q => {
      let val = a.values[q.id];
      if (Array.isArray(val)) val = val.join("; ");
      xls += `<td>${escapeHtml(val || "")}</td>`;
    });
    xls += "</tr>";
  });

  xls += "</table>";
  const blob = new Blob([xls], { type: "application/vnd.ms-excel" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `${currentForm.name || "form_results"}.xls`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

document.getElementById("export-csv").onclick = exportCSV;
document.getElementById("export-excel").onclick = exportExcel;

    function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function escapeAttr(s){ return (s+'').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }
  </script>
</body>
</html>
