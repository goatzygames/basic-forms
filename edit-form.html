<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Edit Form â€” Basic Forms</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="container">
    <header class="topbar">
      <h1>Edit Form</h1>
      <a href="index.html">Create a Form</a>
    </header>
	<br><br><br>

    <!-- Password gate -->
    <section id="password-card" class="card">
      <h2>Enter Password</h2>
      <input id="password-input" type="password" placeholder="Form password" />
      <button id="unlock-btn" class="btn primary">Unlock</button>
      <p class="muted">If no password was set, leave blank.</p>
    </section>

    <!-- Editor -->
    <section id="editor-card" class="card hidden">
      <h2>Form Settings</h2>
      <label class="field">
        <span>Form title</span>
        <input id="edit-title" />
      </label>
      <label class="field">
        <span>Creator name</span>
        <input id="edit-creator" />
      </label>
      <label class="field">
        <span>Password (leave empty to keep current)</span>
        <input id="edit-pass" type="password" />
      </label>

      <h3>Questions</h3>
      <div id="questions-list"></div>

      <div class="row">
        <select id="new-q-type">
          <option value="short">Short text</option>
          <option value="paragraph">Paragraph</option>
          <option value="multiple">Multiple choice</option>
          <option value="checkboxes">Checkboxes</option>
          <option value="dropdown">Dropdown</option>
          <option value="linear">Linear scale</option>
        </select>
        <button id="add-question-btn" class="btn">Add Question</button>
      </div>

      <div class="row right">
        <button id="save-btn" class="btn primary">Save Changes</button>
        <button id="reset-btn" class="btn">Reset Answers</button>
      </div>
    </section>

    <section id="noaccess" class="card hidden">
      <h2>No Access</h2>
      <p>The password is incorrect.</p>
    </section>
  </main>

  <footer class="foot muted">
    <small>Editing powered by Firebase</small>
  </footer>

  <script type="module" src="main.js"></script>
  <script type="module">
    import {
      fetchFormDoc,
      updateFormDoc,
      uidShort
    } from './main.js';

    const params = new URLSearchParams(location.search);
    const formId = params.get('id');

    const pwCard = document.getElementById('password-card');
    const pwInput = document.getElementById('password-input');
    const unlockBtn = document.getElementById('unlock-btn');

    const editorCard = document.getElementById('editor-card');
    const noaccess = document.getElementById('noaccess');
    const titleInput = document.getElementById('edit-title');
    const creatorInput = document.getElementById('edit-creator');
    const passInput = document.getElementById('edit-pass');
    const qList = document.getElementById('questions-list');
    const addQBtn = document.getElementById('add-question-btn');
    const newQType = document.getElementById('new-q-type');
    const saveBtn = document.getElementById('save-btn');
    const resetBtn = document.getElementById('reset-btn');

    let currentForm = null;

    unlockBtn.onclick = async () => {
      const doc = await fetchFormDoc(formId);
      if (!doc) {
        alert('Form not found.');
        return;
      }
      // check password
      if (doc.password && doc.password !== pwInput.value) {
        pwCard.classList.add('hidden');
        noaccess.classList.remove('hidden');
        return;
      }
      currentForm = doc;
      pwCard.classList.add('hidden');
      editorCard.classList.remove('hidden');
      renderEditor();
    };

    function renderEditor() {
      titleInput.value = currentForm.name || '';
      creatorInput.value = currentForm.creatorName || '';
      passInput.value = '';

      qList.innerHTML = '';
      (currentForm.questions || []).forEach(q => {
        const row = document.createElement('div');
        row.className = 'field';
        row.innerHTML = `
          <input data-id="${q.id}" value="${q.label}" />
          <button data-id="${q.id}" class="btn small remove-btn">Remove</button>
        `;
        qList.appendChild(row);
      });

      qList.querySelectorAll('.remove-btn').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-id');
          currentForm.questions = currentForm.questions.filter(q => q.id !== id);
          renderEditor();
        };
      });
    }

    addQBtn.onclick = e => {
      e.preventDefault();
      const q = {
        id: uidShort(),
        type: newQType.value,
        label: 'New question',
        options: (['multiple','checkboxes','dropdown'].includes(newQType.value) ? ['Option 1','Option 2'] : []),
        scaleMin: (newQType.value === 'linear' ? 1 : undefined),
        scaleMax: (newQType.value === 'linear' ? 5 : undefined),
        required: false
      };
      currentForm.questions = [...(currentForm.questions || []), q];
      renderEditor();
    };

    saveBtn.onclick = async () => {
      currentForm.name = titleInput.value.trim();
      currentForm.creatorName = creatorInput.value.trim();
      if (passInput.value.trim()) {
        currentForm.password = passInput.value.trim();
      }
      // update question labels from inputs
      qList.querySelectorAll('input[data-id]').forEach(inp => {
        const q = currentForm.questions.find(x => x.id === inp.getAttribute('data-id'));
        if (q) q.label = inp.value;
      });

      try {
        await updateFormDoc(formId, {
          name: currentForm.name,
          creatorName: currentForm.creatorName,
          password: currentForm.password,
          questions: currentForm.questions
        });
        alert('Changes saved.');
      } catch (err) {
        console.error(err);
        alert('Error saving changes.');
      }
    };

    resetBtn.onclick = async () => {
      if (!confirm('Delete ALL answers?')) return;
      try {
        await updateFormDoc(formId, { answers: [] });
        alert('Answers reset.');
      } catch (err) {
        console.error(err);
        alert('Error resetting answers.');
      }
    };
  </script>
</body>
</html>
